# DolphinScheduler 工作流监控器项目设计文档

## 1. 概述

### 1.1 项目背景
DolphinScheduler 工作流在生产环境中需要持续监控，及时发现失败并自动恢复，以减少人工介入和故障影响。

### 1.2 项目目标
- 持续或单次监控项目内工作流执行状态
- 在满足条件时自动执行失败节点恢复
- 支持时间窗口过滤与失败阈值控制，避免系统性故障时过度恢复
- 支持多渠道通知和通知限流
- 通过调度感知与缓存机制降低 API 调用成本

### 1.3 术语定义
- 工作流实例：一次工作流执行记录
- 工作流定义：工作流模板/流程定义
- 时间窗口：只关注最近指定小时内启动的实例
- 失败阈值：同一工作流定义在时间窗口内失败实例的上限
- 调度感知优化：根据 cron 调度与执行窗口决定是否调用 API

### 1.4 文档范围
描述监控器的总体架构、功能模块、核心流程和部署方式，覆盖 `src/` 目录内主要模块和配置。

## 2. 项目整体架构

### 2.1 系统架构图
```
+--------------------+         +--------------------+
|       CLI/入口      |         |     配置管理层      |
|  cli.py / main.py   |         |  config.py/.env     |
+---------+----------+         +----------+---------+
          |                                 |
          v                                 v
+---------+----------+         +----------+---------+
|       监控核心      |<--------+       日志系统      |
|    monitor.py      |         |     logger.py       |
+----+----+----+-----+         +--------------------+
     |    |    |
     |    |    +--------------------+
     |    |                         |
     v    v                         v
+----+----+----+-----+     +--------+---------+
|   调度追踪与优化    |     |     恢复处理层     |
| schedule_tracker.py|     | recovery_handler |
| cron_parser.py     |     | task_validator   |
+----+---------------+     +--------+---------+
     |                              |
     v                              v
+----+-------------------+   +------+-----------+
|    API 客户端层         |   |   通知系统与限流  |
|  api_client.py          |   | notifiers/*      |
|  api_cache.py           |   | rate_limiter.py  |
|  api_metrics.py         |   +-----------------+
+----+-------------------+
     |
     v
+----+-------------------+
| DolphinScheduler REST   |
|        API 服务         |
+-------------------------+
```

### 2.2 技术选型
- 语言：Python 3
- CLI：`click`
- HTTP 客户端：`requests` + `urllib3 Retry`
- 配置：YAML + `.env` 环境变量
- 日志：`logging` + `colorama` 彩色输出 + `RotatingFileHandler`

### 2.3 目录结构
```
config/                 配置文件
  config.yaml
src/                    业务代码
  api_client.py         DolphinScheduler API 客户端
  api_cache.py          API 缓存
  api_metrics.py        API 调用指标
  cli.py                CLI 入口
  config.py             配置管理
  monitor.py            监控核心
  recovery_handler.py   恢复处理器
  task_validator.py     恢复条件验证器
  schedule_tracker.py   调度状态追踪
  cron_parser.py        Cron 解析器
  logger.py             日志模块
  notifiers/            通知系统
main.py                 程序入口
logs/                   运行日志与状态
```

### 2.4 模块划分

#### 2.4.1 核心模块（CLI、Monitor、Config）
- `src/cli.py`：命令行入口与命令分发
- `src/monitor.py`：监控核心流程与调度优化
- `src/config.py`：配置加载、环境变量覆盖与模型定义

#### 2.4.2 API层（Client、Cache、Metrics）
- `src/api_client.py`：封装 DolphinScheduler API，内置重试与连接池
- `src/api_cache.py`：缓存项目、工作流定义等不常变化数据
- `src/api_metrics.py`：采集 API 调用次数、耗时、错误率

#### 2.4.3 业务处理层（RecoveryHandler、TaskValidator、ScheduleTracker）
- `src/recovery_handler.py`：恢复执行、次数限制、恢复记录持久化
- `src/task_validator.py`：简化验证逻辑，仅检查工作流状态
- `src/schedule_tracker.py`：基于 cron 追踪调度状态与执行窗口

#### 2.4.4 通知系统（Notifiers）
- `src/notifiers/`：钉钉、企业微信、邮件通知器
- `src/notifiers/rate_limiter.py`：通知限流与记录持久化
- `src/notifiers/message_builder.py`：统一消息模板构建

#### 2.4.5 工具模块（Logger、CronParser）
- `src/logger.py`：日志格式、彩色输出、日志轮转
- `src/cron_parser.py`：DolphinScheduler cron 表达式解析

### 2.5 模块依赖关系
- CLI 初始化 Config、Logger、API Client、Monitor
- Monitor 依赖 API Client、ScheduleTracker、RecoveryHandler、NotificationManager
- RecoveryHandler 依赖 TaskValidator、API Client 与恢复状态文件
- Notifiers 依赖 NotificationMessage 与 Logger
- ScheduleTracker 依赖 CronParser 并持久化调度状态

## 3. 项目功能流转说明

### 3.1 系统启动流程
1. CLI 解析参数与配置文件路径
2. Config 加载配置与环境变量覆盖
3. Logger 初始化日志与轮转
4. API Client 初始化缓存与指标收集器
5. Monitor 初始化调度追踪与通知系统

### 3.2 监控检查流程（核心流程）
1. 获取项目与工作流定义
2. 根据调度状态过滤无需检查的工作流
3. 批量查询失败实例并按工作流定义分组
4. 时间窗口过滤，只保留近期实例
5. 失败阈值检查：超过阈值只通知不恢复
6. 对可恢复实例进入恢复流程

### 3.3 工作流恢复流程
1. TaskValidator 校验实例是否满足恢复条件
2. RecoveryHandler 检查恢复次数限制
3. 调用 API 执行失败节点恢复
4. 记录恢复尝试并持久化状态

### 3.4 通知发送流程
1. Monitor 生成通知消息模板
2. NotificationManager 调用已启用通知器
3. 通知限流器记录并控制频次

### 3.5 调度感知优化流程
1. ScheduleTracker 解析 cron 并计算执行窗口
2. 非执行窗口或成功冷却期跳过 API 查询
3. 记录节省的 API 调用统计

### 3.6 异常处理流程
- API 调用失败触发重试机制
- 通知失败不影响主流程
- 状态文件读写异常记录日志并继续运行

## 4. 功能设计

### 4.1 配置管理

#### 4.1.1 配置文件结构
- 配置文件：`config/config.yaml`
- 主要区块：`dolphinscheduler`、`monitor`、`retry`、`projects`、`logging`、`notification`

#### 4.1.2 环境变量覆盖
- 读取 `.env` 与系统环境变量
- 关键变量示例：`DS_API_URL`、`DS_TOKEN`、`DS_CHECK_INTERVAL`

#### 4.1.3 配置优先级
1. 环境变量
2. 配置文件
3. 代码默认值

### 4.2 监控功能

#### 4.2.1 持续监控模式
- `monitor.continuous_mode=true`，按 `check_interval` 周期执行

#### 4.2.2 单次检查模式
- CLI `check` 命令触发单次监控

#### 4.2.3 时间窗口过滤
- 过滤超出 `time_window_hours` 的失败实例

#### 4.2.4 失败阈值检查
- 按工作流定义分组失败实例
- 超过阈值仅通知，不执行恢复

### 4.3 自动恢复功能

#### 4.3.1 恢复条件判断
- 仅检查工作流状态为 `FAILURE`

#### 4.3.2 从失败节点恢复
- 调用 DolphinScheduler 失败节点恢复接口

#### 4.3.3 恢复次数限制
- 基于 `max_recovery_attempts` 控制同一实例恢复次数

#### 4.3.4 恢复记录持久化
- 状态文件：`logs/recovery_state.json`

### 4.4 智能调度优化

#### 4.4.1 Cron表达式解析
- `cron_parser.py` 支持秒/分/时/日/月/周格式

#### 4.4.2 执行窗口计算
- 调度时间后 `execution_window_hours` 作为监控窗口

#### 4.4.3 成功冷却机制
- 成功或恢复成功后 `success_cooldown_minutes` 内跳过监控

#### 4.4.4 API调用优化效果
- 调度过滤与批量查询减少 API 调用
- 统计节省调用次数并输出日志

### 4.5 通知系统

#### 4.5.1 钉钉通知
- Webhook + 可选签名

#### 4.5.2 企业微信通知
- Webhook Markdown 消息

#### 4.5.3 邮件通知
- SMTP 发送 HTML 邮件

#### 4.5.4 通知限流机制
- 24 小时内默认最多 6 次通知
- 状态文件：`logs/notification_rate_limit.json`

#### 4.5.5 通知消息模板
- 失败检测、恢复成功、恢复失败、超过阈值模板

### 4.6 API客户端

#### 4.6.1 接口封装
- 项目、工作流定义、实例与调度信息查询
- 失败节点恢复操作

#### 4.6.2 缓存策略
- `APICache` 缓存项目/定义等低频数据

#### 4.6.3 重试机制
- `urllib3 Retry` 对 POST 请求重试

#### 4.6.4 性能指标收集
- 记录调用次数、耗时、错误率

### 4.7 日志系统

#### 4.7.1 日志级别
- DEBUG、INFO、WARNING、ERROR

#### 4.7.2 日志轮转
- `RotatingFileHandler` 按大小轮转

#### 4.7.3 彩色输出
- 控制台使用 `colorama` 输出彩色日志

## 5. 部署说明

### 5.1 Docker部署
- `docker-compose.yaml` 启动服务
- 通过 `.env` 配置 Token 与主机映射

### 5.2 本地运行
- 安装依赖：`pip install -r requirements.txt`
- 启动监控：`python main.py run`

### 5.3 环境变量配置
- 必需：`DS_TOKEN`
- 常用：`DS_API_URL`、`DS_CHECK_INTERVAL`、`DS_TIME_WINDOW_HOURS`
- 通知：`DS_DINGTALK_*`、`DS_WEWORK_*`、`DS_EMAIL_*`

## 6. 附录

### 6.1 API接口列表
- `get_projects`：项目列表
- `get_process_definitions`：工作流定义列表
- `get_workflow_schedules`：工作流调度配置
- `get_workflow_schedule_map`：调度映射
- `get_workflow_instances`：实例列表
- `get_failed_workflow_instances`：失败实例列表
- `execute_failure_recovery`：失败节点恢复
- `get_task_instances`：任务实例查询

### 6.2 状态码定义
- 成功：`SUCCESS`
- 失败：`FAILURE`、`KILL`、`NEED_FAULT_TOLERANCE`
- 运行中：`RUNNING_EXECUTION`、`SUBMITTED_SUCCESS`、`WAITING_DEPEND`

### 6.3 配置参数说明
- `monitor.check_interval`：检查间隔秒数
- `monitor.time_window_hours`：时间窗口小时数
- `monitor.max_failures_for_recovery`：失败阈值
- `monitor.enable_schedule_optimization`：调度感知优化开关
- `retry.max_recovery_attempts`：最大恢复次数
- `retry.auto_recovery`：自动恢复开关
- `logging.file`：日志文件路径
- `notification.*`：通知渠道配置
